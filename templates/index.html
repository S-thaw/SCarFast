<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ตัวช่วยคำนวณสินเชื่อรถ • Pd × D.va (Themeable)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{--brand:#4fd1c5;--brand-2:#63b3ed;--ink:#141414;--ink-inv:#ffffff} /* default: Teal Sky */
body{font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#f6f7fb;color:var(--ink)}
.navbar{background:linear-gradient(135deg,var(--brand),var(--brand-2));}
.navbar-brand{font-weight:700}
.card{border:0;box-shadow:0 8px 24px rgba(20,20,20,.06);border-radius:16px}
.section-title{font-weight:700}
.form-label{font-weight:600}
.small-muted{font-size:.9rem;color:#6b7280}
.badge-soft{background:color-mix(in srgb, var(--brand) 12%, #ffffff);color:#2b2c34;border:1px solid color-mix(in srgb, var(--brand) 30%, #ffffff);font-weight:600}

.result-item{padding:12px !important}
.result-sep{height:4px;background:linear-gradient(90deg,var(--brand),var(--brand-2));margin:6px 0 10px;border-radius:8px}
.monthly-bill{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:var(--ink-inv);padding:.25rem .6rem;border-radius:10px;display:inline-block;font-weight:800;font-size:1.4rem;line-height:1}

.summary-wrap{overflow:auto}
.summary-table{--bd:#dfe3ea;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
.summary-table thead th{position:sticky;top:0;background:#f3f4f6;border-bottom:1px solid var(--bd);font-weight:700;cursor:pointer;user-select:none}
.summary-table th,.summary-table td{padding:.55rem .65rem;border-bottom:1px solid var(--bd);vertical-align:middle}
.summary-table td.text-end{font-variant-numeric:tabular-nums}
.th-sort-asc::after{content:" \25B2";}
.th-sort-desc::after{content:" \25BC";}

@media print{
  @page{ size:A4 portrait; margin:12mm; }
  *{ -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  nav, #leftFormCard, .nonprint, #chartsCard { display:none !important; }
  #summaryCard, #printHeader { display:block !important; box-shadow:none !important; }
  .summary-table{border:1px solid #cfd4dc}
  .summary-table tr{break-inside:avoid}
}
#printHeader{display:none;padding:8px 0;margin-bottom:8px;border-bottom:2px solid #e5e7eb}
</style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container py-2 d-flex flex-wrap gap-3 align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#"><span class="badge bg-light text-dark">Calculator</span> ตัวช่วยคำนวณสินเชื่อรถ</a>
    <div class="d-flex align-items-center gap-2 text-white">
      <label class="me-1 mb-0 small">โทนสีรถ</label>
      <select id="themeSelect" class="form-select form-select-sm" style="width:240px">
        <option value="teal_sky">Teal Sky (ฟ้า-เขียว)</option>
        <option value="midnight_cyan">Midnight Cyan (กรมท่า-ฟ้า)</option>
        <option value="crimson_black">Crimson Black (แดง-ดำ)</option>
        <option value="emerald_mint">Emerald Mint (เขียว-มินต์)</option>
        <option value="indigo_gold">Indigo Gold (น้ำเงินคราม-ทอง)</option>
        <option value="graphite_orange">Graphite Orange (เทา-ส้ม)</option>
        <option value="ruby_slate">Ruby Slate (แดงทับทิม-เทา)</option>
        <option value="forest_lime">Forest Lime (เขียวเข้ม-ไลม์)</option>
        <option value="navy_peach">Navy Peach (กรมท่า-พีช)</option>
        <option value="purple_rose">Purple Rose (ม่วง-ชมพู)</option>
      </select>
    </div>
  </div>
</nav>

<main class="container my-4 my-sm-5">
  <div id="printHeader">
    <div class="d-flex justify-content-between align-items-end">
      <div class="h5 mb-0">Loan Comparison Report</div>
      <div class="small text-muted" id="printTime"></div>
    </div>
  </div>
  <div class="row g-4">
    <div class="col-12 col-lg-5" id="leftFormCard">
      <div class="card p-3 p-sm-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="section-title h5 mb-0">ตั้งค่าการคำนวณ</h2>
          <span class="small-muted">รองรับหลายรุ่น/ข้อเสนอ</span>
        </div>

        <form method="POST" id="loanForm" novalidate>
          <input type="hidden" name="num_cars" id="num_cars" value="{{ num_cars or 1 }}" />
          <div class="d-flex gap-2 align-items-center mb-3">
            <div class="flex-grow-1">
              <label class="form-label">จำนวนรายการที่จะเปรียบเทียบ</label>
              <input type="number" class="form-control" min="1" max="10" id="compareCount" value="{{ num_cars or 1 }}" />
              <div class="small-muted">ตั้งจำนวนแล้วฟอร์มจะสร้างช่องให้อัตโนมัติ</div>
            </div>
            <button type="button" class="btn btn-outline-secondary mt-4" id="applyCount">ตกลง</button>
          </div>

          <div id="carsWrapper" class="d-grid gap-3"></div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary flex-grow-1" id="calcBtn">คำนวณ</button>
            <button type="reset" class="btn btn-outline-secondary" id="resetBtn">ล้างค่า</button>
          </div>
          <div class="small text-danger mt-2" id="formError" style="display:none"></div>
        </form>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card p-3 p-sm-4 results-card nonprint" id="resultsCard">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="section-title h5 mb-0">ผลลัพธ์แบบการ์ด</h2>
          <button class="btn btn-sm btn-outline-secondary" id="copyBestBtn" disabled>คัดลอกชื่อดีลที่ค่างวดต่ำสุด</button>
        </div>
        {% if results and results|length > 0 %}
        <div class="row g-3 mt-1 results-list">
          {% for r in results %}
          <div class="col-12">
            <div class="card result-item">
              <div class="p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="text-muted small">ชื่อรุ่น/ดีล</div>
                    <div class="fw-bold">{{ r.name or 'ไม่ระบุ' }}</div>
                  </div>
                  <span class="badge bg-light text-dark">งวด {{ r.months }} เดือน</span>
                </div>
                <div class="result-sep"></div>
                <div class="row g-2 align-items-end">
                  <div class="col-6">
                    <div class="small text-muted">ยอดจัดไฟแนนซ์</div>
                    <div class="fw-semibold"><span class="badge badge-soft rounded-3 px-2 py-1">฿{{ "{:,.2f}".format(r.loan_amount or 0) }}</span></div>
                  </div>
                  <div class="col-6 text-end">
                    <div class="small text-muted">ค่างวด/เดือน</div>
                    <div class="monthly-bill">฿{{ "{:,.2f}".format(r.monthly_payment or 0) }}</div>
                    <div class="text-muted mt-1 small">{{ 'ลดต้นลดดอก' if r.interest_type=='effective' else 'ดอกคงที่ (Add-on)' }} • {{ "{:,.2f}".format(r.interest_rate or 0) }}% ต่อปี × {{ r.years }} ปี</div>
                  </div>
                  <div class="col-6"><div class="small text-muted">ราคาตั้งต้น</div><div class="fw-semibold">฿{{ "{:,.2f}".format(r.original_price or 0) }}</div></div>
                  <div class="col-6 text-end"><div class="small text-muted">ส่วนลด</div><div class="fw-semibold">฿{{ "{:,.2f}".format(r.discount_amount or 0) }} ({{ "{:,.2f}".format(r.discount_rate or 0) }}%)</div></div>
                  <div class="col-6"><div class="small text-muted">ราคาหลังหักส่วนลด</div><div class="fw-semibold">฿{{ "{:,.2f}".format(r.discounted_price or 0) }}</div></div>
                  <div class="col-6 text-end"><div class="small text-muted">เงินดาวน์</div><div class="fw-semibold">฿{{ "{:,.2f}".format(r.down_amount or 0) }} ({{ "{:,.2f}".format(r.down_rate or 0) }}%)</div></div>
                  <div class="col-6"><div class="small text-muted">ดอกเบี้ยรวม</div><div class="fw-semibold"><span class="badge badge-soft rounded-3 px-2 py-1">฿{{ "{:,.2f}".format(r.total_interest or 0) }}</span></div></div>
                  <div class="col-6 text-end"><div class="small text-muted">ยอดรวมต้องชำระ</div><div class="fw-semibold">฿{{ "{:,.2f}".format(r.total_amount or 0) }}</div></div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
          <div class="mb-2">ยังไม่มีผลลัพธ์</div>
          <div class="text-muted">กรอกข้อมูลทางซ้ายแล้วกด “คำนวณ”</div>
        </div>
        {% endif %}
      </div>

      {% if results and results|length > 0 %}
      <div class="card p-3 p-sm-4 mt-3 nonprint" id="chartsCard">
        <h2 class="section-title h6 mb-2">แผนภูมิประกอบ</h2>
        <canvas id="barMonthly" height="140"></canvas>
      </div>
      {% endif %}

      <div class="card p-3 p-sm-4 mt-3" id="summaryCard">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="section-title h5 mb-0">ตารางสรุปเปรียบเทียบ (พร้อมพิมพ์)</h2>
          <div class="d-flex gap-2">
            <button id="exportCsvBtn" class="btn btn-outline-secondary btn-sm" disabled>Export CSV</button>
            <button id="exportXlsxBtn" class="btn btn-outline-secondary btn-sm" disabled>Export XLSX</button>
            <button id="printBtn" class="btn btn-outline-secondary btn-sm" disabled>พิมพ์/Export PDF</button>
          </div>
        </div>
        {% if results and results|length > 0 %}
        <div class="summary-wrap">
          <table class="table table-sm summary-table" id="summaryTable">
            <thead>
              <tr>
                <th data-key="name">รุ่น/ดีล</th>
                <th class="text-end" data-key="original_price" data-num>MSRP</th>
                <th class="text-end" data-key="discount_amount" data-num>ส่วนลด (฿)</th>
                <th class="text-end" data-key="discount_rate" data-num>ส่วนลด (%)</th>
                <th class="text-end" data-key="discounted_price" data-num>ราคาหลังลด</th>
                <th class="text-end" data-key="down_amount" data-num>เงินดาวน์ (฿)</th>
                <th class="text-end" data-key="down_rate" data-num>ดาวน์ (%)</th>
                <th class="text-end" data-key="loan_amount" data-num>ยอดจัด</th>
                <th class="text-end" data-key="total_interest" data-num>ดบ.รวม</th>
                <th class="text-end" data-key="total_amount" data-num>ยอดรวม</th>
                <th class="text-end" data-key="monthly_payment" data-num>ค่างวด/เดือน</th>
                <th class="text-end" data-key="interest_rate" data-num>ดบ./ปี</th>
                <th class="text-end" data-key="months" data-num>ระยะเวลา (ด.)</th>
                <th>ประเภท</th>
                <th class="text-end">ตารางผ่อน</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
          </table>
        </div>
        <div class="small-muted mt-2">* เลือกได้ทั้ง ดอกคงที่ (Add-on) และ ลดต้นลดดอก (Effective)</div>
        {% else %}
        <div class="text-muted small">จะมีตารางหลังจากมีผลลัพธ์อย่างน้อย 1 รายการ</div>
        {% endif %}
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="amortModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ตารางผ่อน</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted" id="amortMeta"></div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="amortCsvBtn">Export CSV</button>
            <button class="btn btn-sm btn-outline-secondary" id="amortXlsxBtn">Export XLSX</button>
            <button class="btn btn-sm btn-outline-secondary" id="amortPrintBtn">พิมพ์</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm" id="amortTable">
            <thead>
              <tr>
                <th>งวด</th>
                <th class="text-end">ยอดคงเหลือต้น</th>
                <th class="text-end">ดอกเบี้ยงวดนี้</th>
                <th class="text-end">ตัดต้นงวดนี้</th>
                <th class="text-end">ค่างวด</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<template id="carTemplate">
  <div class="card p-3 car-block">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="h6 mb-0">รายการ <span class="car-index">1</span></h3>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary cloneBtn">ทำซ้ำ</button>
        <button type="button" class="btn btn-sm btn-outline-danger d-none d-sm-inline removeBtn">ลบ</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-12">
        <label class="form-label">ชื่อรุ่น/ดีล</label>
        <input type="text" class="form-control" name="car_name__IDX__" placeholder="เช่น Civic RS 2025 - โปรโมชั่น A" />
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ราคารถ (บาท) <span class="text-danger">*</span></label>
        <input required min="1" type="number" inputmode="decimal" step="0.01" class="form-control" name="car_price__IDX__" />
        <div class="invalid-feedback">ใส่ราคารถมากกว่า 0</div>
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ดอกเบี้ยต่อปี (%)</label>
        <input min="0" type="number" inputmode="decimal" step="0.01" class="form-control" name="interest_rate__IDX__" />
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ส่วนลด (บาท)</label>
        <input min="0" type="number" inputmode="decimal" step="0.01" class="form-control" name="discount_amount__IDX__" />
        <div class="small-muted">ใส่บาท หรือเปอร์เซ็นต์ อย่างใดอย่างเดียว</div>
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ส่วนลด (%)</label>
        <input min="0" type="number" inputmode="decimal" step="0.01" class="form-control" name="discount_percent__IDX__" />
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">เงินดาวน์ (บาท)</label>
        <input min="0" type="number" inputmode="decimal" step="0.01" class="form-control" name="down_amount__IDX__" />
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">เงินดาวน์ (%)</label>
        <input min="0" type="number" inputmode="decimal" step="0.01" class="form-control" name="down_percent__IDX__" />
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ระยะเวลาผ่อน (ปี) <span class="text-danger">*</span></label>
        <input required min="1" max="9" type="number" inputmode="numeric" step="1" class="form-control" name="years__IDX__" />
        <div class="invalid-feedback">ใส่จำนวนปี 1–9</div>
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ประเภทดอกเบี้ย</label>
        <select class="form-select" name="interest_type__IDX__">
          <option value="addon" selected>ดอกคงที่ (Simple/Add-on)</option>
          <option value="effective">ลดต้นลดดอก (Effective)</option>
        </select>
      </div>
      <div class="col-12 col-sm-6 d-sm-none">
        <button type="button" class="btn btn-outline-danger w-100 removeBtn">ลบรายการนี้</button>
      </div>
    </div>
  </div>
</template>

<script>
function baht(n){ try{ return '฿'+(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }catch(e){ return '฿'+(n||0); } }
function pct(n){ try{ return (n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})+'%'; }catch(e){ return (n||0)+'%'; } } // force 2 decimals
const carsWrapper = document.getElementById('carsWrapper');
const applyCountBtn = document.getElementById('applyCount');
const compareCount = document.getElementById('compareCount');
const numCarsInput = document.getElementById('num_cars');
const resetBtn = document.getElementById('resetBtn');
const loanForm = document.getElementById('loanForm');
const formError = document.getElementById('formError');
const themeSelect = document.getElementById('themeSelect');

// 10 two-tone themes with strong contrast
const THEMES = {
  teal_sky:       {brand:'#4fd1c5', brand2:'#63b3ed', inv:'#ffffff'},
  midnight_cyan:  {brand:'#0f172a', brand2:'#06b6d4', inv:'#ffffff'}, // navy + cyan
  crimson_black:  {brand:'#ef4444', brand2:'#111827', inv:'#ffffff'}, // red + near-black
  emerald_mint:   {brand:'#10b981', brand2:'#a7f3d0', inv:'#0b1520'},  // green + mint
  indigo_gold:    {brand:'#4338ca', brand2:'#f59e0b', inv:'#ffffff'},  // indigo + gold
  graphite_orange:{brand:'#374151', brand2:'#fb923c', inv:'#ffffff'},  // gray + orange
  ruby_slate:     {brand:'#be123c', brand2:'#475569', inv:'#ffffff'},  // ruby + slate
  forest_lime:    {brand:'#065f46', brand2:'#84cc16', inv:'#ffffff'},  // forest + lime
  navy_peach:     {brand:'#1e3a8a', brand2:'#fdba74', inv:'#ffffff'},  // navy + peach
  purple_rose:    {brand:'#7c3aed', brand2:'#f472b6', inv:'#ffffff'}   // purple + rose
};

function applyTheme(key){
  const t = THEMES[key] || THEMES.teal_sky;
  const root = document.documentElement;
  root.style.setProperty('--brand', t.brand);
  root.style.setProperty('--brand-2', t.brand2);
  root.style.setProperty('--ink-inv', t.inv || '#ffffff');
  // update chart colors if rendered
  if(window.__barChart){
    const cs = getComputedStyle(root);
    const c1 = cs.getPropertyValue('--brand').trim();
    window.__barChart.data.datasets[0].backgroundColor = c1+'33'; // translucent
    window.__barChart.data.datasets[0].borderColor = c1;
    window.__barChart.update();
  }
  localStorage.setItem('loanTheme', key);
}
themeSelect.addEventListener('change', (e)=> applyTheme(e.target.value));
(function restoreTheme(){
  const t = localStorage.getItem('loanTheme') || 'teal_sky';
  themeSelect.value = t; applyTheme(t);
})();

function addListenersToBlock(block){
  block.querySelectorAll('.removeBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      block.remove(); updateIndexes();
      numCarsInput.value = document.querySelectorAll('.car-block').length || 1;
      compareCount.value = numCarsInput.value;
      persistDraft();
    });
  });
  block.querySelectorAll('.cloneBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const clone = block.cloneNode(true);
      carsWrapper.appendChild(clone);
      updateIndexes();
      numCarsInput.value = document.querySelectorAll('.car-block').length || 1;
      compareCount.value = numCarsInput.value;
      addListenersToBlock(clone);
      persistDraft();
    });
  });
  block.querySelectorAll('input,select').forEach(inp=>{
    inp.addEventListener('input', persistDraft);
  });
}
function buildCarBlock(idx){
  const tpl = document.getElementById('carTemplate').content.cloneNode(true);
  const block = tpl.querySelector('.car-block');
  block.querySelector('.car-index').textContent = idx;
  block.querySelectorAll('input,select').forEach(inp=>{ inp.name = inp.name.replace('__IDX__', idx); });
  addListenersToBlock(block);
  return block;
}
function updateIndexes(){
  document.querySelectorAll('.car-block').forEach((b,i)=>{
    const n = i+1;
    b.querySelector('.car-index').textContent = n;
    b.querySelectorAll('input,select').forEach(inp=>{
      const base = inp.name.replace(/\d+$/, '');
      inp.name = base + n;
    });
  });
}
function renderBlocks(count){
  carsWrapper.innerHTML = '';
  const n = Math.max(1, Math.min(10, parseInt(count||1,10)));
  for(let i=1;i<=n;i++){ carsWrapper.appendChild(buildCarBlock(i)); }
  numCarsInput.value = n; compareCount.value = n;
}
renderBlocks({{ num_cars or 1 }});
applyCountBtn.addEventListener('click', ()=>{ renderBlocks(compareCount.value); persistDraft(); });
resetBtn.addEventListener('click', ()=>{ setTimeout(()=>{ renderBlocks(1); localStorage.removeItem('loanDraft'); }, 0); });

loanForm.addEventListener('submit', (e)=>{
  formError.style.display='none'; formError.textContent='';
  let ok = true;
  document.querySelectorAll('.car-block').forEach(b=>{
    const price = b.querySelector('input[name^="car_price"]').valueAsNumber||0;
    const years = b.querySelector('input[name^="years"]').valueAsNumber||0;
    if(price<=0 || years<=0){ ok=false; b.querySelectorAll('input').forEach(i=>i.reportValidity()); }
  });
  if(!ok){
    e.preventDefault();
    formError.textContent = 'กรุณากรอก ราคารถ (>0) และ ระยะเวลาผ่อน (ปี) อย่างน้อย 1 รายการ';
    formError.style.display='block';
  }
});

function persistDraft(){
  const n = document.querySelectorAll('.car-block').length;
  const rows = [];
  document.querySelectorAll('.car-block').forEach((b,i)=>{
    function val(sel){ return b.querySelector(sel)?.value || ''; }
    rows.push({
      name: val('input[name^="car_name"]'),
      price: val('input[name^="car_price"]'),
      ir: val('input[name^="interest_rate"]'),
      disc_amt: val('input[name^="discount_amount"]'),
      disc_pct: val('input[name^="discount_percent"]'),
      down_amt: val('input[name^="down_amount"]'),
      down_pct: val('input[name^="down_percent"]'),
      years: val('input[name^="years"]'),
      itype: val('select[name^="interest_type"]')
    });
  });
  localStorage.setItem('loanDraft', JSON.stringify({count:n, rows}));
}
(function restoreDraft(){
  const s = localStorage.getItem('loanDraft');
  if(!s) return;
  try{
    const draft = JSON.parse(s);
    renderBlocks(draft.count||1);
    const blocks = document.querySelectorAll('.car-block');
    (draft.rows||[]).forEach((row,idx)=>{
      const b = blocks[idx]; if(!b) return;
      function set(name,val){ const el=b.querySelector(`[name^="${name}"]`); if(el) el.value = val||''; }
      set('car_name', row.name);
      set('car_price', row.price);
      set('interest_rate', row.ir);
      set('discount_amount', row.disc_amt);
      set('discount_percent', row.disc_pct);
      set('down_amount', row.down_amt);
      set('down_percent', row.down_pct);
      set('years', row.years);
      set('interest_type', row.itype);
    });
  }catch(e){}
})();

{% if results and results|length > 0 %}
const data = {{ results|tojson }};
window.__exportData = data;
const tbody = document.getElementById('summaryBody');
if(tbody){
  const labelType = (t)=> t==='effective' ? 'ลดต้นลดดอก' : 'ดอกคงที่';
  const rows = data.map((d,i)=>`<tr data-idx="${i}">
    <td>${d.name||'-'}</td>
    <td class="text-end" data-val="${d.original_price||0}">${baht(d.original_price)}</td>
    <td class="text-end" data-val="${d.discount_amount||0}">${baht(d.discount_amount)}</td>
    <td class="text-end" data-val="${d.discount_rate||0}">${pct(d.discount_rate)}</td>
    <td class="text-end" data-val="${d.discounted_price||0}">${baht(d.discounted_price)}</td>
    <td class="text-end" data-val="${d.down_amount||0}">${baht(d.down_amount)}</td>
    <td class="text-end" data-val="${d.down_rate||0}">${pct(d.down_rate)}</td>
    <td class="text-end" data-val="${d.loan_amount||0}">${baht(d.loan_amount)}</td>
    <td class="text-end" data-val="${d.total_interest||0}">${baht(d.total_interest)}</td>
    <td class="text-end" data-val="${d.total_amount||0}">${baht(d.total_amount)}</td>
    <td class="text-end" data-val="${d.monthly_payment||0}">${baht(d.monthly_payment)}</td>
    <td class="text-end" data-val="${d.interest_rate||0}">${pct(d.interest_rate)}</td>
    <td class="text-end" data-val="${d.months||0}">${d.months||0}</td>
    <td>${labelType(d.interest_type)}</td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-primary amortBtn" data-idx="${i}">ดูตาราง</button></td>
  </tr>`).join('');
  tbody.innerHTML = rows;
}

document.getElementById('exportCsvBtn')?.removeAttribute('disabled');
document.getElementById('exportXlsxBtn')?.removeAttribute('disabled');
document.getElementById('printBtn')?.removeAttribute('disabled');

(function enableSort(){
  const thead = document.querySelector('#summaryTable thead');
  const tbody = document.querySelector('#summaryTable tbody');
  let curKey=null, curDir=1;
  thead?.addEventListener('click', (e)=>{
    const th = e.target.closest('th'); if(!th) return;
    const key = th.dataset.key; if(!key) return;
    const num = th.hasAttribute('data-num');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((ra,rb)=>{
      const idxA = +ra.dataset.idx, idxB = +rb.dataset.idx;
      const a = data[idxA][key] || 0;
      const b = data[idxB][key] || 0;
      const va = num? +a : String(a);
      const vb = num? +b : String(b);
      if(va<vb) return -1*curDir;
      if(va>vb) return 1*curDir;
      return 0;
    });
    document.querySelectorAll('#summaryTable thead th').forEach(x=>x.classList.remove('th-sort-asc','th-sort-desc'));
    if(curKey===key){ curDir*=-1; } else { curDir=1; }
    th.classList.add(curDir===1?'th-sort-asc':'th-sort-desc');
    curKey=key;
    rows.forEach(r=>tbody.appendChild(r));
  });
})();

function exportCSV(data){
  const header = ['Name','MSRP','Discount(฿)','Discount(%)','PriceAfterDiscount','Down(฿)','Down(%)','LoanAmount','TotalInterest','TotalAmount','Years','Months','InterestRate','MonthlyPayment','InterestType'];
  const rows = data.map(d=>[
    d.name||'', d.original_price||0, d.discount_amount||0, d.discount_rate||0,
    d.discounted_price||0, d.down_amount||0, d.down_rate||0,
    d.loan_amount||0, d.total_interest||0, d.total_amount||0,
    d.years||0, d.months||0, d.interest_rate||0, d.monthly_payment||0, d.interest_type||''
  ]);
  const csv = [header].concat(rows).map(r=> r.map(x=> typeof x==='string' && x.includes(',') ? '"' + x.replaceAll('"','""') + '"' : x).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='loan_comparison.csv'; a.click(); URL.revokeObjectURL(url);
}
document.getElementById('exportCsvBtn')?.addEventListener('click', ()=> exportCSV(window.__exportData||[]));

function exportXLSX(data){
  const rows = [['Name','MSRP','Discount(฿)','Discount(%)','PriceAfterDiscount','Down(฿)','Down(%)','LoanAmount','TotalInterest','TotalAmount','Years','Months','InterestRate','MonthlyPayment','InterestType']];
  data.forEach(d=> rows.push([
    d.name||'', d.original_price||0, d.discount_amount||0, d.discount_rate||0,
    d.discounted_price||0, d.down_amount||0, d.down_rate||0,
    d.loan_amount||0, d.total_interest||0, d.total_amount||0,
    d.years||0, d.months||0, d.interest_rate||0, d.monthly_payment||0, d.interest_type||''
  ]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Comparison');
  XLSX.writeFile(wb, 'loan_comparison.xlsx');
}
document.getElementById('exportXlsxBtn')?.addEventListener('click', ()=> exportXLSX(window.__exportData||[]));

document.getElementById('printBtn')?.addEventListener('click', ()=>{
  const ts = new Date().toLocaleString('th-TH');
  const el = document.getElementById('printTime'); if(el) el.textContent = ts;
  window.print();
});

(function enableCopyBest(){
  if(!data?.length) return;
  const best = [...data].sort((a,b)=> (a.monthly_payment||0)-(b.monthly_payment||0))[0];
  const btn = document.getElementById('copyBestBtn');
  if(btn){ btn.removeAttribute('disabled');
    btn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(best?.name||''); btn.textContent='คัดลอกแล้ว'; setTimeout(()=>btn.textContent='คัดลอกชื่อดีลที่ค่างวดต่ำสุด',1500);}catch(e){}
    });
  }
})();

(function renderCharts(){
  const labels = (window.__exportData||[]).map(d=> d.name||'-');
  const monthly = (window.__exportData||[]).map(d=> d.monthly_payment||0);
  const ctx = document.getElementById('barMonthly');
  if(ctx){
    const cs = getComputedStyle(document.documentElement);
    const c1 = cs.getPropertyValue('--brand').trim();
    window.__barChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'ค่างวด/เดือน (บาท)', data: monthly, backgroundColor: c1+'33', borderColor:c1, borderWidth:1 }]},
      options:{ responsive:true, plugins:{ legend:{ display:true }}, scales:{ y:{ beginAtZero:true } } }
    });
  }
})();

const amortModalEl = document.getElementById('amortModal');
const amortMeta = document.getElementById('amortMeta');
const amortBody = document.querySelector('#amortTable tbody');
let amortCurrent = null;

function formatBaht(x){ return (x||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

async function fetchAmort(d){
  const res = await fetch('/api/amort', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ loan_amount: d.loan_amount, interest_rate: d.interest_rate, months: d.months, interest_type: d.interest_type })
  });
  const js = await res.json();
  return js.rows||[];
}

function labelType(t){ return t==='effective' ? 'ลดต้นลดดอก' : 'ดอกคงที่ (Add-on)'; }

async function openAmort(d){
  const rows = await fetchAmort(d);
  amortBody.innerHTML = rows.map(r=>`<tr>
    <td>${r.k}</td>
    <td class="text-end">฿${formatBaht(r.balance)}</td>
    <td class="text-end">฿${formatBaht(r.interest)}</td>
    <td class="text-end">฿${formatBaht(r.principal)}</td>
    <td class="text-end">฿${formatBaht(r.pay)}</td>
  </tr>`).join('');
  amortMeta.textContent = `${d.name||'-'} • ${labelType(d.interest_type)} • ยอดจัด ${baht(d.loan_amount)} • ดบ. ${(d.interest_rate||0).toFixed(2)}% ต่อปี • ${d.months||0} งวด • ค่างวด ${baht(d.monthly_payment)}`;
  amortCurrent = {deal:d, rows};
  const modal = new bootstrap.Modal(amortModalEl); modal.show();
}

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.amortBtn'); if(!btn) return;
  const i = +btn.dataset.idx;
  const d = (window.__exportData||[])[i];
  openAmort(d);
});

document.getElementById('amortCsvBtn')?.addEventListener('click', ()=>{
  if(!amortCurrent) return;
  const header = ['#','Balance','Interest','Principal','Payment'];
  const rows = amortCurrent.rows.map(r=>[r.k, r.balance, r.interest, r.principal, r.pay]);
  const csv = [header].concat(rows).map(r=>r.join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`amort_${(amortCurrent.deal.name||'deal').replaceAll(' ','_')}.csv`; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('amortXlsxBtn')?.addEventListener('click', ()=>{
  if(!amortCurrent) return;
  const rows = [['#','Balance','Interest','Principal','Payment']];
  amortCurrent.rows.forEach(r=> rows.push([r.k, r.balance, r.interest, r.principal, r.pay]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Amortization');
  XLSX.writeFile(wb, `amort_${(amortCurrent.deal.name||'deal').replaceAll(' ','_')}.xlsx`);
});
document.getElementById('amortPrintBtn')?.addEventListener('click', ()=>{
  window.print();
});
{% endif %}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
